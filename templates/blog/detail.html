{% extends "base.html" %}
{% load hitcount_tags %}
{% load staticfiles %}
{% get_hit_count for post as total_hits %}

{% block title_block %}
    {{ post.title }}
{% endblock %}

{% block src_block %}
    <script src="{% static 'blog/js/hitcount/jquery.postcsrf.js' %}"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});







    </script>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>

{% endblock %}

{% block body_block %}
    {% get_hit_count_js_variables for post as hitcount %}
    {% get_hit_count for post as total_hits %}
    <div id="body" class="row" style="max-width:1200px; margin: 0 auto">
        <div class="col-md-3  col-sm-12 order-md-2 content">
            <div id="content">
                <h3>{{ post.title }}</h3>
                {{ post.toc|safe }}
            </div>
        </div>
        <div class="col-md-9 col-sm-12 order-md-1">
            {#    header#}
            <header>
                <h1>{{ post.title }}</h1>
                <div class="post-meta">
                    <span class="post-category"><a href="#">{{ post.category.name }}</a></span>
                    &nbsp; | &nbsp;
                    <span class="post-date">
                        <time class="entry-date" datetime="{{ post.created_time }}">
                            {{ post.created_date_display }}
                        </time>
                    </span>
                    &nbsp; | &nbsp;
                    <span class="views-count">{{ total_hits }} <i class="far fa-eye"></i></span>
                </div>
            </header>
            <hr>
            {#  article  #}
            <div id="article">
                {{ post.body|safe }}
            </div>
            <hr>

        </div>


<div id="vcomments" class="col-md-9 order-md-3">Comments</div>
    </div>

    <style>


        .toc {
            float: left;
            overflow-y: auto;
        }

        pre {
            padding: 5px;
            border-radius: 10px;
            display: block;
            font-size: 13px;
            line-height: 1.42857143;
            color: #333;
            word-break: break-all;
            background-color: #f1f3f1;
            -webkit-overflow-scrolling: touch;
            max-height: 60vh;
            overflow: auto;
        }

        .toc ul {
            -webkit-padding-start: 20px;
            list-style-type: none;
        }

        #body a, #body a:visited {
            border-bottom: 1px rgb(48, 65, 80) dotted;
        }

        #body a:hover {
            color: rgb(91, 160, 162);
            border-bottom: 1px rgb(91, 160, 162) dotted;
            text-decoration: none;
        }

        #body h1, h2, h3, h4, h5, h6 {
            padding-top: 0.5em;
            color: rgb(48, 65, 80);
            font-family: -apple-system, 'Roboto Slab', "Helvetica Neue", Microsoft Yahei, serif
        }

        img {
            max-width: 100%;
        }

        #article {
            padding: 20px 0 20px 0;
        }

        .stickyTop {
            position: fixed;
            top: 0;
            width: 100%;
            background-color: #eeeeea;
            padding-top: 0;
        }

        pre::-webkit-scrollbar-track, .toc::-webkit-scrollbar-track {
            -webkit-box-shadow: rgba(0, 0, 0, 0.3);
            border-radius: 10px;

        }

        pre::-webkit-scrollbar, .toc::-webkit-scrollbar {
            width: 3px;
            height: 8px;

        }

        pre::-webkit-scrollbar-thumb, .toc::-webkit-scrollbar-thumb {
            border-radius: 20px;
            -webkit-box-shadow: rgba(79, 79, 79, 0.3);
            background-color: #b7b7b7;
        }

        .current {
            background-color: rgba(197, 197, 197, 0.2);
            color: black;
            text-shadow: 1px 0px 0px black;
        }

        @media only screen and (min-width: 768px) {
            .content {
                position: sticky;
                top: 1px;
                max-height: 20px;
            }
        }

    </style>
    <script>
        $(document).ready(function () {
            $(window).scroll(function () {
                let scrollTop = $(window).scrollTop();
                let headers = $("#article :header");
                let allDown = true;
                headers.each(function (index, header) {
                    let headerTop = $(this).offset().top;

                    if (headerTop > scrollTop) {
                        let header = $(headers[index - 1]);

                        let id = header.attr('id');
                        if ($(window).width() > 1200) {
                            headers.removeClass("stickyTop");
                            header.addClass("stickyTop");
                        }
                        $('li a').removeClass('current');
                        let toc = $('a[href$="' + id + '"]');
                        toc.addClass("current");
                        allDown = false;
                        return false;

                    }
                })
                if (allDown) {
                    headers.removeClass("stickyTop");
                }
            });
        });


        $(document).ready(function ($) {
            $.postCSRF("{{ hitcount.ajax_url }}", {hitcountPK: "{{ hitcount.pk }}"})
                .done(console.log("{{ hitcount.ajax_url }}"))
        });

        let gitalk = new Gitalk({
            clientID: '8115dfa9163da65c4620',
            clientSecret: '6dfe12047d10198bb4300a6d03d073ed955abeaa',
            repo: 'jiang-blog-comment',
            owner: 'DayuanJiang',
            admin: 'DayuanJiang',
            distractionFreeMode: false,  // Facebook-like distraction free mode
            language: "en",
            id: "{% url 'blog:detail' post.pk %}"
        })

        gitalk.render('gitalk-container')
        new Valine({
            el: '#vcomments',
            appId: 'xF18lrCyCtn6nclXIr0toQIO-gzGzoHsz',
            appKey: 'ekKaUG1eX8Aae885vwsUw1rA'
        })

    </script>
{% endblock %}